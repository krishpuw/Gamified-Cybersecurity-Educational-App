<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Questions · Cyber Game</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    /* Shared gamified theme */
    @keyframes glowPulse { 0%,100%{box-shadow:0 0 20px rgba(34,197,94,.3),0 0 40px rgba(34,197,94,.1)} 50%{box-shadow:0 0 30px rgba(34,197,94,.5),0 0 60px rgba(34,197,94,.2)} }
    @keyframes scanLine { 0%{transform:translateY(-100%)} 100%{transform:translateY(100vh)} }
    @keyframes blink { 0%,100%{opacity:1} 50%{opacity:0} }
    @keyframes slideIn { from{opacity:0; transform:translateY(-20px)} to{opacity:1; transform:translateY(0)} }
    @keyframes float { 0%,100% { transform: translateY(0px) translateX(0px) } 25% { transform: translateY(-20px) translateX(10px) } 50% { transform: translateY(-10px) translateX(-10px) } 75% { transform: translateY(-30px) translateX(5px) } }
    .glow-pulse{animation:glowPulse 2s infinite}
    .scan-line{animation:scanLine 4s linear infinite}
    .blink{animation:blink 1s infinite}
    .slide-in{animation:slideIn .5s ease-out}
    .grid-bg{
      background-image:
        linear-gradient(rgba(34,197,94,.1) 1px, transparent 1px),
        linear-gradient(90deg, rgba(34,197,94,.1) 1px, transparent 1px);
      background-size: 30px 30px;
    }
    .terminal-text{font-family:'Courier New', monospace}

    /* Circular timer ring using conic-gradient */
    .timer-ring{
      --pct: 0;
      background:
        radial-gradient(closest-side, rgba(15,23,42,1) 78%, transparent 80% 100%),
        conic-gradient(#22c55e var(--pct), rgba(30,41,59,.6) 0);
    }

    /* Accessibility: reduce motion */
    @media (prefers-reduced-motion: reduce){
      *{animation: none !important; transition: none !important}
      .scan-line{display:none !important}
    }
  </style>
</head>
<body class="bg-slate-950 text-white min-h-screen overflow-x-hidden">
  <!-- Background + scan -->
  <div class="fixed inset-0 bg-gradient-to-br from-slate-950 via-slate-900 to-slate-950 grid-bg"></div>
  <div class="fixed top-0 w-full h-0.5 bg-gradient-to-r from-transparent via-green-500 to-transparent opacity-30 scan-line"></div>
  <!-- Corners -->
  <div class="fixed top-4 left-4 w-12 h-12 border-t-2 border-l-2 border-green-500/30"></div>
  <div class="fixed top-4 right-4 w-12 h-12 border-t-2 border-r-2 border-green-500/30"></div>
  <div class="fixed bottom-4 left-4 w-12 h-12 border-b-2 border-l-2 border-green-500/30"></div>
  <div class="fixed bottom-4 right-4 w-12 h-12 border-b-2 border-r-2 border-green-500/30"></div>

  <!-- Particles -->
  <div id="particles" class="fixed inset-0 pointer-events-none"></div>

  <div class="relative z-10 max-w-5xl mx-auto px-4 py-8 lg:py-10">
    <!-- Header -->
    <header class="mb-6 slide-in">
      <div class="flex items-center justify-between gap-4 flex-wrap">
        <div class="flex items-center gap-3">
          <div class="relative w-12 h-12">
            <div class="absolute inset-0 bg-green-500 blur-xl opacity-40 animate-pulse"></div>
            <svg class="relative w-12 h-12 text-green-400" fill="none" stroke="currentColor" viewBox="0 0 24 24" aria-hidden="true">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M12 15v2m-6 4h12a2 2 0 002-2v-6a2 2 0 00-2-2H6a2 2 0 00-2 2v6a2 2 0 002 2zm10-10V7a4 4 0 00-8 0v4h8z"/>
            </svg>
          </div>
          <div>
            <h1 class="text-3xl lg:text-4xl font-extrabold text-green-400 terminal-text tracking-wide">Q/A PHASE</h1>
            <p id="meta" class="text-sm text-gray-400">Preparing questions…</p>
          </div>
        </div>

        <!-- Live status bars -->
        <div class="flex flex-col items-end gap-2 w-full sm:w-auto">
          <!-- XP strip -->
          <div id="xpStrip" class="text-sm text-gray-300 flex items-center gap-4">
            <span>XP: <strong id="xpReal" class="text-green-400">—</strong></span>
            <span>This round: <strong id="xpSession" class="text-emerald-300">+0</strong></span>
          </div>
          <!-- Score/streak -->
          <div class="flex items-center gap-3">
            <div class="text-sm text-gray-300">Score: <strong id="scoreVal" class="text-blue-300">0</strong></div>
            <div class="text-sm text-gray-300">Streak: <strong id="streakVal" class="text-yellow-300">0</strong></div>
          </div>
        </div>
      </div>
    </header>

    <!-- Progress -->
    <div class="mb-6">
      <div class="flex items-center justify-between text-sm text-gray-300 mb-1">
        <span>Question <span id="qnum" class="font-semibold">1</span> / <span id="qtotal" class="font-semibold">7</span></span>
        <span id="progPct">0%</span>
      </div>
      <div class="w-full h-2 bg-slate-800 rounded-full overflow-hidden">
        <div id="progBar" class="h-2 bg-gradient-to-r from-green-500 to-emerald-600 rounded-full" style="width: 0%"></div>
      </div>
    </div>

    <!-- Main card -->
    <div id="card" class="bg-slate-900/80 border-2 border-green-500/30 rounded-2xl p-6 lg:p-8 glow-pulse backdrop-blur-sm">
      <div class="flex flex-col lg:flex-row gap-6">
        <!-- Left: question + choices -->
        <div class="flex-1">
          <div id="stem" class="text-2xl lg:text-3xl font-semibold mb-6 leading-snug">Loading…</div>

          <div id="choices" class="grid grid-cols-1 gap-3"></div>

          <div class="mt-6 flex items-center justify-between gap-3 flex-wrap">
            <div id="footer" class="text-xs text-gray-400 flex items-center gap-3">
              <span id="tier-badge" class="px-2 py-1 rounded bg-slate-800 border border-slate-700">Tier: —</span>
              <span id="timer" class="ml-1">⏱ <span id="time-left">--</span>s</span>
              <span class="hidden sm:inline text-gray-500">|</span>
              <span class="text-gray-500">Hotkeys: <span class="font-mono">A/B/C/D</span> or <span class="font-mono">1–4</span>, <span class="font-mono">Enter</span></span>
            </div>

            <div class="flex items-center gap-2">
              <button id="prev" class="px-4 py-3 text-base rounded-lg bg-slate-800 border border-slate-700 disabled:opacity-50">← Previous</button>
              <button id="submit" class="px-6 py-3 text-base font-bold rounded-lg bg-green-600 hover:bg-green-700 disabled:opacity-50">Submit</button>
              <button id="next" class="px-4 py-3 text-base rounded-lg bg-blue-600 hover:bg-blue-700 disabled:opacity-50">Next →</button>
            </div>
          </div>

          <div id="explanation" class="mt-5 text-base text-gray-200 hidden"></div>
        </div>

        <!-- Right: timer ring + score bar -->
        <div class="w-full lg:w-64 shrink-0">
          <!-- Timer Ring -->
          <div class="flex items-center justify-center">
            <div class="timer-ring w-40 h-40 rounded-full grid place-items-center border-4 border-emerald-500/20" id="timerRing" style="--pct: 0deg">
              <div class="w-32 h-32 rounded-full bg-slate-950 grid place-items-center border border-emerald-500/40">
                <div class="text-center">
                  <div class="text-4xl font-extrabold" id="timeLeftBig">--</div>
                  <div class="text-xs text-gray-400">seconds</div>
                </div>
              </div>
            </div>
          </div>

          <!-- Score bar -->
          <div class="mt-6">
            <div class="flex items-center justify-between text-sm text-gray-300 mb-1">
              <span>Score Progress</span>
              <span id="scorePct">0%</span>
            </div>
            <div class="w-full h-3 bg-slate-800 rounded-full overflow-hidden">
              <div id="scoreBar" class="h-3 bg-gradient-to-r from-blue-500 to-cyan-400 rounded-full" style="width: 0%"></div>
            </div>
          </div>

          <!-- Streak meter -->
          <div class="mt-4">
            <div class="flex items-center justify-between text-sm text-gray-300 mb-1">
              <span>Streak</span>
              <span id="streakHint" class="text-yellow-300">x0</span>
            </div>
            <div class="w-full h-2 bg-slate-800 rounded-full overflow-hidden">
              <div id="streakBar" class="h-2 bg-yellow-400 rounded-full" style="width: 0%"></div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Session Summary Modal -->
    <div id="summaryModal" class="fixed inset-0 z-50 hidden items-center justify-center bg-black/60">
      <div class="bg-slate-900 border-2 border-green-500/30 rounded-2xl p-6 w-full max-w-2xl backdrop-blur-sm">
        <h3 class="text-3xl font-bold text-green-400 mb-2 terminal-text">SESSION SUMMARY <span class="blink">_</span></h3>
        <p id="summarySub" class="text-sm text-gray-300 mb-4">Great work — here’s how you did.</p>

        <div class="grid grid-cols-3 gap-3 text-sm text-gray-200 mb-4">
          <div class="bg-slate-800/70 p-4 rounded">
            <div class="text-xs text-gray-400">Correct</div>
            <div id="summary-correct" class="text-2xl font-semibold">0</div>
          </div>
          <div class="bg-slate-800/70 p-4 rounded">
            <div class="text-xs text-gray-400">Session XP</div>
            <div id="summary-xp" class="text-2xl font-semibold">+0</div>
          </div>
          <div class="bg-slate-800/70 p-4 rounded">
            <div class="text-xs text-gray-400">Score Gain</div>
            <div id="summary-score" class="text-2xl font-semibold">+0</div>
          </div>
          <div class="bg-slate-800/70 p-4 rounded col-span-3">
            <div class="text-xs text-gray-400">New Badges</div>
            <div id="summary-badges" class="mt-2"></div>
          </div>
        </div>

        <div class="flex justify-end gap-2">
          <button id="summaryRetry" class="px-4 py-3 rounded-lg bg-slate-800 border border-slate-700">Try another set</button>
          <button id="summaryDashboard" class="px-4 py-3 rounded-lg bg-green-600 hover:bg-green-700">Back to Dashboard</button>
        </div>
      </div>
    </div>
  </div>

  <script>
    /* ---------- Particles ---------- */
    (function () {
      const particlesContainer = document.getElementById('particles');
      for (let i = 0; i < 18; i++) {
        const p = document.createElement('div');
        p.className = 'absolute w-1 h-1 bg-green-400 rounded-full opacity-40';
        p.style.left = Math.random() * 100 + '%';
        p.style.top = Math.random() * 100 + '%';
        p.style.animation = `float ${Math.random() * 20 + 10}s infinite ease-in-out ${Math.random() * 5}s`;
        p.style.boxShadow = '0 0 10px rgba(34,197,94,0.6)';
        particlesContainer.appendChild(p);
      }
    })();
  </script>

  <!-- Core Logic -->
  <script>
    // URL params
    const params = new URLSearchParams(location.search);
    const userId = Number(params.get("user_id") || "0");
    const xpParam = params.get("xp") ? Number(params.get("xp")) : null;
    const tactic = params.get("tactic") || "Reconnaissance";
    const technique_id = params.get("technique_id") || null;

    // DOM refs
    const metaEl = document.getElementById("meta");
    const qnumEl = document.getElementById("qnum");
    const qtotalEl = document.getElementById("qtotal");
    const progBar = document.getElementById("progBar");
    const progPctEl = document.getElementById("progPct");

    const stemEl = document.getElementById("stem");
    const choicesEl = document.getElementById("choices");
    const submitBtn = document.getElementById("submit");
    const nextBtn = document.getElementById("next");
    const prevBtn = document.getElementById("prev");

    const explEl = document.getElementById("explanation");
    const tierBadge = document.getElementById("tier-badge");

    const timeLeftSmall = document.getElementById("time-left");
    const timeLeftBig = document.getElementById("timeLeftBig");
    const timerRing = document.getElementById("timerRing");

    const xpRealEl = document.getElementById("xpReal");
    const xpSessionEl = document.getElementById("xpSession");
    const scoreVal = document.getElementById("scoreVal");
    const scoreBar = document.getElementById("scoreBar");
    const scorePct = document.getElementById("scorePct");
    const streakVal = document.getElementById("streakVal");
    const streakBar = document.getElementById("streakBar");
    const streakHint = document.getElementById("streakHint");

    // Summary modal
    const summaryModal = document.getElementById("summaryModal");
    const summaryCorrectEl = document.getElementById("summary-correct");
    const summaryXpEl = document.getElementById("summary-xp");
    const summaryScoreEl = document.getElementById("summary-score");
    const summaryBadgesEl = document.getElementById("summary-badges");
    const summaryRetryBtn = document.getElementById("summaryRetry");
    const summaryDashboardBtn = document.getElementById("summaryDashboard");

    // State
    const TOTAL = 7;
    qtotalEl.textContent = TOTAL;

    let batch = [];
    let idx = 0;
    let selection = null;
    let answerKey = null;

    let timer = null;
    let timeLeft = 0;
    let timeTotal = 0;

    let currentTier = "simple";
    let xpReward = 0;

    let sessionXp = 0;
    let realXp = null;

    let score = 0;           // simple cumulative score
    let scoreMax = TOTAL * 100; // assume each question 100 pts max baseline
    let streak = 0;

    let results = []; // { qid, correct, xp_gain, new_badges, points }

    function setProg(i){
      const pct = Math.round((i / TOTAL) * 100);
      progBar.style.width = pct + "%";
      progPctEl.textContent = pct + "%";
    }

    function setScoreUI(){
      const pct = Math.min(100, Math.round((score / Math.max(1, scoreMax)) * 100));
      scoreVal.textContent = String(score);
      scoreBar.style.width = pct + "%";
      scorePct.textContent = pct + "%";
    }

    function setStreakUI(){
      streakVal.textContent = String(streak);
      streakHint.textContent = "x" + String(streak);
      const pct = Math.min(100, streak * (100 / TOTAL));
      streakBar.style.width = pct + "%";
    }

    async function loadRealXp(){
      if(!userId) return;
      try{
        const res = await fetch(`/api/user/${userId}/progress`);
        if(!res.ok) throw new Error("progress");
        const p = await res.json();
        realXp = Number(p?.xp ?? 0);
        xpRealEl.textContent = realXp;
        xpSessionEl.textContent = `+${sessionXp}`;
      }catch(e){
        // keep placeholders
      }
    }

    function renderQuestion(i){
      const item = batch[i];
      if(!item) return;

      qnumEl.textContent = i + 1;
      setProg(i);

      stemEl.textContent = item.question;
      choicesEl.innerHTML = "";
      submitBtn.disabled = true;
      nextBtn.disabled = true;
      prevBtn.disabled = i === 0;
      explEl.classList.add("hidden");
      selection = null;

      const labels = ["A","B","C","D"];
      answerKey = item.answer_key;

      currentTier = item?.difficulty_meta?.tier || "simple";
      xpReward = item?.difficulty_meta?.xp_reward || 5;
      tierBadge.textContent = `Tier: ${currentTier} (+${xpReward} XP if correct)`;

      (item.choices || []).forEach((choice, ci) => {
        const lab = labels[ci] || "?";
        const btn = document.createElement("button");
        btn.className = "w-full text-left px-4 py-4 text-lg rounded-xl bg-slate-800 border border-slate-700 hover:bg-slate-700 transition ring-0";
        btn.innerHTML = `<span class="font-mono text-emerald-300">${lab}.</span> <span class="align-middle">${choice}</span>`;
        btn.onclick = () => setSelection(lab, btn);
        choicesEl.appendChild(btn);
      });

      // Timer
      if(timer) clearInterval(timer);
      timeTotal = item?.difficulty_meta?.time_s || 45;
      timeLeft = timeTotal;
      timeLeftSmall.textContent = timeLeft;
      timeLeftBig.textContent = timeLeft;
      setTimerRing(0); // start fresh
      timer = setInterval(() => {
        timeLeft -= 1;
        const elapsed = Math.max(0, timeTotal - timeLeft);
        setTimerRing(elapsed / timeTotal);
        const t = Math.max(0, timeLeft);
        timeLeftSmall.textContent = t;
        timeLeftBig.textContent = t;
        if(timeLeft <= 0){
          clearInterval(timer);
          submitBtn.disabled = true;
          nextBtn.disabled = false;
          explEl.textContent = item.explanation || "Time up.";
          explEl.classList.remove("hidden");
        }
      }, 1000);
    }

    function setTimerRing(frac){
      // frac 0..1 -> degrees
      const deg = Math.min(360, Math.max(0, Math.round(frac * 360)));
      timerRing.style.setProperty('--pct', deg + "deg");
    }

    function setSelection(lab, btn){
      selection = lab;
      [...choicesEl.children].forEach(ch => ch.classList.remove("ring-2","ring-blue-400"));
      btn.classList.add("ring-2","ring-blue-400");
      submitBtn.disabled = false;
    }

    function questionPoints(correct){
      // baseline 100 pts; bonus for time remaining and streak
      const timeBonus = Math.max(0, Math.round((timeLeft / Math.max(1, timeTotal)) * 30));
      const streakBonus = Math.min(30, streak * 5);
      return correct ? (100 + timeBonus + streakBonus) : 0;
    }

    async function sendEngagement(item, correct){
      try{
        const res = await fetch("/api/engagement/update", {
          method: "POST",
          headers: {"Content-Type":"application/json"},
          body: JSON.stringify({
            user_id: userId,
            operation_id: null,
            question_id: item?.id || `q-${idx+1}`,
            is_correct: correct,
            response_time_ms: ((item?.difficulty_meta?.time_s || 45) - Math.max(0,timeLeft)) * 1000,
            difficulty: (item?.difficulty_meta?.tier || "easy")
          })
        });
        return await res.json();
      }catch(e){
        console.warn("engagement update failed", e);
        return {};
      }
    }

    submitBtn.addEventListener("click", async () => {
      const item = batch[idx];
      const correct = selection === answerKey;

      // show explanation
      explEl.textContent = (item.explanation || "") + (correct ? " ✅" : " ❌");
      explEl.classList.remove("hidden");
      submitBtn.disabled = true;
      nextBtn.disabled = false;
      if(timer) clearInterval(timer);

      // scoring + streak
      if(correct){ streak += 1; } else { streak = 0; }
      setStreakUI();

      const pts = questionPoints(correct);
      score += pts; setScoreUI();

      // server update
      const payload = await sendEngagement(item, correct);
      const gained = Number(payload?.xp_gain ?? (correct ? xpReward : 0));
      const new_badges = payload?.new_badges || [];

      // record
      results.push({ qid: item?.id || `q-${idx+1}`, correct, xp_gain: gained, new_badges, points: pts });

      // live XP
      sessionXp += gained; xpSessionEl.textContent = `+${sessionXp}`;
      const newXp = Number(payload?.new_xp ?? ((realXp ?? 0) + gained));
      realXp = newXp; xpRealEl.textContent = realXp;
    });

    nextBtn.addEventListener("click", () => {
      if(idx < batch.length - 1){
        idx += 1;
        renderQuestion(idx);
        return;
      }
      // finished -> summary
      const correctCount = results.filter(r => r.correct).length;
      summaryCorrectEl.textContent = `${correctCount} / ${batch.length || TOTAL}`;
      summaryXpEl.textContent = `+${sessionXp}`;
      const sessionScoreGain = results.reduce((a,b)=>a + (b.points||0), 0);
      summaryScoreEl.textContent = `+${sessionScoreGain}`;

      const allBadges = results.flatMap(r => r.new_badges || []);
      const uniqueBadges = [...new Set(allBadges)];
      summaryBadgesEl.innerHTML = uniqueBadges.length
        ? uniqueBadges.map(b => `<span class="inline-block bg-slate-800 px-2 py-1 rounded mr-1 text-xs border border-slate-700">${b}</span>`).join("")
        : '<span class="text-sm text-gray-400">No new badges this session</span>';

      summaryModal.classList.remove("hidden"); summaryModal.classList.add("flex");
    });

    prevBtn.addEventListener("click", () => {
      if(idx > 0){ idx -= 1; renderQuestion(idx); }
    });

    summaryRetryBtn.addEventListener("click", async () => {
      results = []; sessionXp = 0; streak = 0; setStreakUI();
      xpSessionEl.textContent = `+${sessionXp}`;
      score = 0; setScoreUI();
      summaryModal.classList.add("hidden"); summaryModal.classList.remove("flex");
      await loadBatch().catch(()=>window.location.reload());
    });
    summaryDashboardBtn.addEventListener("click", () => { window.location.href = "/game"; });

    // Hotkeys: A/B/C/D or 1–4; Enter=submit/next
    document.addEventListener("keydown", (e) => {
      const map = { 'a':0,'b':1,'c':2,'d':3, '1':0,'2':1,'3':2,'4':3 };
      const key = e.key.toLowerCase();
      if(key in map && choicesEl.children[map[key]]){
        e.preventDefault();
        choicesEl.children[map[key]].click();
      } else if(key === 'enter'){
        e.preventDefault();
        if(!submitBtn.disabled){ submitBtn.click(); }
        else if(!nextBtn.disabled){ nextBtn.click(); }
      }
    });

    // Load batch
    async function loadBatch(){
      await loadRealXp();
      const payload = { user_id: userId, tactic, technique_id };
      if(xpParam !== null) payload.xp = xpParam;
      const res = await fetch("/api/questions/generate7", {
        method: "POST",
        headers: {"Content-Type":"application/json"},
        body: JSON.stringify(payload)
      });
      const data = await res.json();
      if(!res.ok) throw new Error(data.error || "Failed to get questions");
      batch = data.items || [];
      metaEl.textContent = `Tier resolved: ${data.tier} · Generated: ${data.count}`;
      idx = 0; score = 0; setScoreUI(); streak = 0; setStreakUI();
      setProg(0);
      renderQuestion(idx);
    }

    loadBatch().catch(err => { metaEl.textContent = "Error loading questions"; console.error(err); });
  </script>
</body>
</html>
