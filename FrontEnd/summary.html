<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>Session Summary â€” Debugging Complete</title>
  <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-gray-900 text-white min-h-screen">
  <main class="max-w-3xl mx-auto p-6 text-center">
    <h1 class="text-3xl font-bold text-green-400 mb-3">ðŸŽ‰ You have successfully FINISHED DEBUGGING THE ATTACK</h1>
    <p id="sub" class="text-sm text-gray-300 mb-6">Nice work â€” hereâ€™s how you did this round.</p>

    <div class="bg-gray-800 rounded-xl p-6 mb-4 text-left">
      <div class="mb-2"><strong>Session</strong></div>
      <div class="flex justify-between"><div>Correct:</div><div id="summary-correct">â€”</div></div>
      <div class="flex justify-between"><div>Questions:</div><div id="summary-total">â€”</div></div>
      <div class="flex justify-between"><div>XP earned this session:</div><div id="summary-xp">â€”</div></div>
    </div>

    <div class="bg-gray-800 rounded-xl p-6 mb-4 text-left">
      <div class="mb-2"><strong>Current Progress</strong></div>
      <div class="flex justify-between"><div>XP:</div><div id="user-xp">â€”</div></div>
      <div class="flex justify-between"><div>Level:</div><div id="user-level">â€”</div></div>
      <div class="flex justify-between"><div>Score:</div><div id="user-score">â€”</div></div>
      <div class="mt-3" id="user-badges"></div>
    </div>

    <div class="flex gap-3 justify-center mt-4">
      <a id="back-dash" href="/game" class="px-4 py-2 rounded bg-green-600 hover:bg-green-700">Back to Dashboard</a>
      <a id="play-again" href="/questions" class="px-4 py-2 rounded bg-blue-600 hover:bg-blue-700">Play Again</a>
    </div>

    <p class="text-xs text-gray-500 mt-6">Automatically returning to dashboard in <span id="countdown">10</span>sâ€¦</p>
  </main>

  <script>
    // Read query params passed from Questions page
    const params = new URLSearchParams(location.search);
    const userId = params.get('user_id') || null;
    const correct = Number(params.get('correct') || 0);
    const sessionXp = Number(params.get('session_xp') || 0);
    const total = Number(params.get('total') || 7);

    document.getElementById('summary-correct').textContent = correct;
    document.getElementById('summary-total').textContent = total;
    document.getElementById('summary-xp').textContent = `+${sessionXp}`;

    async function loadUserProgress() {
      if (!userId) return;
      try {
        const res = await fetch(`/api/user/${userId}/progress`);
        if (!res.ok) throw new Error('progress');
        const p = await res.json();
        document.getElementById('user-xp').textContent = p.xp ?? 0;
        document.getElementById('user-level').textContent = p.level ?? 1;
        document.getElementById('user-score').textContent = p.score ?? 0;
        const bwrap = document.getElementById('user-badges');
        if ((p.badges||[]).length === 0) {
          bwrap.innerHTML = '<span class="text-sm text-gray-400">No new badges</span>';
        } else {
          bwrap.innerHTML = (p.badges||[]).map(b => `<span class="inline-block bg-gray-700 px-2 py-1 rounded mr-1 text-xs">${b}</span>`).join('');
        }
      } catch (e) {
        console.warn('could not load progress', e);
      }
    }

    loadUserProgress();

    // Auto-redirect countdown
    let t = 10;
    const cd = document.getElementById('countdown');
    const id = setInterval(() => {
      t -= 1;
      cd.textContent = t;
      if (t <= 0) {
        clearInterval(id);
        window.location.href = '/game';
      }
    }, 1000);
  </script>
</body>
</html>
